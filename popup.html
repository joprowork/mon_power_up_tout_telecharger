<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>T√©l√©charger les pi√®ces jointes</title>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            padding: 12px;
            margin: 0;
            background: #fff;
        }
        .info {
            margin-bottom: 12px;
            padding: 8px;
            background: #f4f5f7;
            border-radius: 4px;
            font-size: 14px;
        }
        .count {
            font-weight: bold;
            color: #0079bf;
        }
        .btn-download {
            width: 100%;
            padding: 10px 16px;
            background: #0079bf;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-download:hover {
            background: #026aa7;
        }
        .btn-download:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
        }
        .progress {
            margin-top: 12px;
            font-size: 13px;
            color: #5e6c84;
            text-align: center;
        }
        .error {
            color: #eb5a46;
            margin-top: 8px;
            font-size: 13px;
        }
        .success {
            color: #61bd4f;
            margin-top: 8px;
            font-size: 13px;
            text-align: center;
        }
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .file-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }
        .file-link {
            color: #0079bf;
            text-decoration: none;
            font-weight: 500;
        }
        .file-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="info">
        <span id="attachmentInfo">Chargement...</span>
    </div>
    <button id="downloadBtn" class="btn-download" disabled>
        üì• T√©l√©charger tous les fichiers
    </button>
    <div id="progress" class="progress" style="display: none;"></div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="success" class="success" style="display: none;"></div>
    <div id="fileList" class="file-list" style="display: none;"></div>

    <script>
        var t = TrelloPowerUp.iframe();
        var cardAttachments = [];
        var cardName = '';

        t.render(function() {
            t.card('id', 'name', 'attachments').then(function(card) {
                cardName = card.name;
                var attachments = card.attachments || [];
                
                // Filtrer les fichiers
                cardAttachments = attachments.filter(function(att) {
                    return att.url && (att.mimeType || att.url.indexOf('trello') !== -1 || att.bytes > 0);
                });
                
                var infoEl = document.getElementById('attachmentInfo');
                var btnEl = document.getElementById('downloadBtn');
                var fileListEl = document.getElementById('fileList');
                
                if (cardAttachments.length === 0) {
                    infoEl.innerHTML = '‚ùå Aucun fichier sur cette carte.';
                    btnEl.style.display = 'none';
                } else {
                    infoEl.innerHTML = 'üìé <span class="count">' + cardAttachments.length + '</span> fichier(s) trouv√©(s)';
                    btnEl.disabled = false;
                    
                    // Afficher la liste des fichiers
                    var listHtml = '';
                    cardAttachments.forEach(function(att, index) {
                        listHtml += '<div class="file-item">';
                        listHtml += '<span class="file-name">' + att.name + '</span>';
                        listHtml += '<a href="' + att.url + '" target="_blank" download="' + att.name + '" class="file-link">üì•</a>';
                        listHtml += '</div>';
                    });
                    fileListEl.innerHTML = listHtml;
                    fileListEl.style.display = 'block';
                }
            });
        });

        function startDownload() {
            var btnEl = document.getElementById('downloadBtn');
            var progressEl = document.getElementById('progress');
            var successEl = document.getElementById('success');
            
            btnEl.disabled = true;
            btnEl.textContent = '‚è≥ T√©l√©chargement...';
            progressEl.style.display = 'block';
            progressEl.textContent = 'Ouverture des fichiers...';
            
            var delay = 0;
            var downloaded = 0;
            
            cardAttachments.forEach(function(att, index) {
                setTimeout(function() {
                    // Ouvrir chaque fichier dans un nouvel onglet pour t√©l√©chargement
                    var link = document.createElement('a');
                    link.href = att.url;
                    link.download = att.name;
                    link.target = '_blank';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    downloaded++;
                    progressEl.textContent = 'T√©l√©charg√© ' + downloaded + '/' + cardAttachments.length;
                    
                    if (downloaded === cardAttachments.length) {
                        progressEl.style.display = 'none';
                        successEl.style.display = 'block';
                        successEl.textContent = '‚úÖ ' + downloaded + ' fichier(s) t√©l√©charg√©(s) !';
                        btnEl.textContent = '‚úÖ Termin√© !';
                    }
                }, delay);
                delay += 500; // 500ms entre chaque t√©l√©chargement
            });
        }

        document.getElementById('downloadBtn').addEventListener('click', startDownload);
    </script>
</body>
</html>
