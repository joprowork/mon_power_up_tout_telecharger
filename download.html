<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>T√©l√©chargement des pi√®ces jointes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background: #f4f5f7;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0 0 20px 0;
            font-size: 20px;
            color: #172b4d;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status.loading { background: #e4f0f6; color: #0079bf; }
        .status.success { background: #e4f7e4; color: #1d7a1d; }
        .status.error { background: #fce4e4; color: #c9372c; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #dfe1e6;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: #0079bf;
            transition: width 0.3s;
            width: 0%;
        }
        .progress-text {
            font-size: 13px;
            color: #5e6c84;
            text-align: center;
        }
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dfe1e6;
            border-radius: 4px;
            margin-top: 15px;
        }
        .file-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .file-item:last-child { border-bottom: none; }
        .file-item.done { color: #1d7a1d; }
        .file-item.error { color: #c9372c; }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #0079bf;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 15px;
        }
        .btn:hover { background: #026aa7; }
        .btn.secondary { background: #dfe1e6; color: #172b4d; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üì• T√©l√©chargement des pi√®ces jointes</h1>
        <div id="status" class="status loading">Initialisation...</div>
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        <div id="progressText" class="progress-text"></div>
        <div id="fileList" class="file-list" style="display:none;"></div>
        <div id="actions"></div>
    </div>

    <script>
        var API_KEY = '28d80811d05a80d515472323f02aab53';
        var APP_NAME = 'Attachments Downloader';
        var RETURN_URL = window.location.href.split('#')[0];
        
        var statusEl = document.getElementById('status');
        var progressFill = document.getElementById('progressFill');
        var progressText = document.getElementById('progressText');
        var fileListEl = document.getElementById('fileList');
        var actionsEl = document.getElementById('actions');
        
        var urlParams = new URLSearchParams(window.location.search);
        var cardId = urlParams.get('cardId');
        var cardName = urlParams.get('cardName') || 'carte';
        
        var token = null;
        var hash = window.location.hash;
        if (hash && hash.indexOf('token=') !== -1) {
            token = hash.split('token=')[1].split('&')[0];
            localStorage.setItem('trello_token', token);
            window.history.replaceState({}, document.title, RETURN_URL);
        } else {
            token = localStorage.getItem('trello_token');
        }
        
        function setStatus(msg, type) {
            statusEl.textContent = msg;
            statusEl.className = 'status ' + type;
        }
        
        function setProgress(current, total, text) {
            progressFill.style.width = (total > 0 ? (current/total)*100 : 0) + '%';
            progressText.textContent = text || '';
        }
        
        function authorize() {
            window.location.href = 'https://trello.com/1/authorize?' +
                'expiration=never&name=' + encodeURIComponent(APP_NAME) +
                '&scope=read&response_type=token&key=' + API_KEY +
                '&return_url=' + encodeURIComponent(RETURN_URL);
        }
        
        async function getAttachments() {
            var r = await fetch('https://api.trello.com/1/cards/' + cardId + '/attachments?key=' + API_KEY + '&token=' + token);
            if (!r.ok) {
                if (r.status === 401) {
                    localStorage.removeItem('trello_token');
                    throw new Error('Token expir√©');
                }
                throw new Error('Erreur API');
            }
            return r.json();
        }
        
        async function downloadWithProxy(url) {
            // Liste de proxies CORS gratuits
            var proxies = [
                'https://corsproxy.io/?',
                'https://api.codetabs.com/v1/proxy?quest='
            ];
            
            for (var i = 0; i < proxies.length; i++) {
                try {
                    var proxyUrl = proxies[i] + encodeURIComponent(url);
                    var r = await fetch(proxyUrl);
                    if (r.ok) {
                        var blob = await r.blob();
                        if (blob.size > 100) return blob; // V√©rifier que c'est pas une erreur
                    }
                } catch(e) { }
            }
            return null;
        }
        
        function sanitize(name) {
            return name.replace(/[<>:"/\\|?*]/g, '_').substring(0, 200);
        }
        
        async function main() {
            if (!cardId) {
                setStatus('Erreur: ID carte manquant', 'error');
                return;
            }
            
            if (!token) {
                setStatus('Connexion Trello requise...', 'loading');
                setTimeout(authorize, 1500);
                return;
            }
            
            try {
                setStatus('R√©cup√©ration des fichiers...', 'loading');
                var attachments = await getAttachments();
                var files = attachments.filter(function(a) { return a.url && a.bytes > 0; });
                
                if (files.length === 0) {
                    setStatus('Aucun fichier trouv√©', 'error');
                    return;
                }
                
                fileListEl.style.display = 'block';
                fileListEl.innerHTML = files.map(function(f) {
                    return '<div class="file-item">‚è≥ ' + (f.name || 'fichier') + '</div>';
                }).join('');
                
                setStatus('T√©l√©chargement de ' + files.length + ' fichier(s)...', 'loading');
                
                var zip = new JSZip();
                var ok = 0, fail = 0;
                var usedNames = {};
                
                for (var i = 0; i < files.length; i++) {
                    var f = files[i];
                    var name = sanitize(f.name || 'fichier_' + i);
                    
                    // √âviter doublons
                    if (usedNames[name]) {
                        var parts = name.split('.');
                        var ext = parts.length > 1 ? '.' + parts.pop() : '';
                        name = parts.join('.') + '_' + usedNames[name] + ext;
                    }
                    usedNames[name] = (usedNames[name] || 0) + 1;
                    
                    setProgress(i+1, files.length, 'Fichier ' + (i+1) + '/' + files.length);
                    
                    var blob = await downloadWithProxy(f.url);
                    var items = fileListEl.querySelectorAll('.file-item');
                    
                    if (blob) {
                        zip.file(name, blob);
                        ok++;
                        items[i].className = 'file-item done';
                        items[i].textContent = '‚úÖ ' + name;
                    } else {
                        fail++;
                        items[i].className = 'file-item error';
                        items[i].textContent = '‚ùå ' + name;
                    }
                }
                
                if (ok === 0) {
                    setStatus('‚ùå Impossible de t√©l√©charger les fichiers (CORS bloqu√©)', 'error');
                    actionsEl.innerHTML = '<button class="btn" onclick="location.reload()">R√©essayer</button><button class="btn secondary" onclick="window.close()">Fermer</button>';
                    return;
                }
                
                setStatus('Cr√©ation du ZIP...', 'loading');
                var zipBlob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE' });
                var zipName = sanitize(decodeURIComponent(cardName)) + '.zip';
                saveAs(zipBlob, zipName);
                
                setStatus('‚úÖ ' + ok + ' fichier(s) t√©l√©charg√©(s) !' + (fail ? ' (' + fail + ' erreur(s))' : ''), 'success');
                setProgress(100, 100, 'Termin√© !');
                actionsEl.innerHTML = '<button class="btn secondary" onclick="window.close()">Fermer</button>';
                
            } catch(e) {
                setStatus('Erreur: ' + e.message, 'error');
                if (e.message.indexOf('Token') !== -1) {
                    actionsEl.innerHTML = '<button class="btn" onclick="authorize()">Se reconnecter</button>';
                }
            }
        }
        
        main();
    </script>
</body>
</html>
