<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>T√©l√©chargement des pi√®ces jointes</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background: #f4f5f7;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0 0 20px 0;
            font-size: 20px;
            color: #172b4d;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status.loading { background: #e4f0f6; color: #0079bf; }
        .status.success { background: #e4f7e4; color: #1d7a1d; }
        .status.error { background: #fce4e4; color: #c9372c; }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #0079bf;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #0079bf;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 15px;
            text-decoration: none;
        }
        .btn:hover { background: #026aa7; }
        .btn.secondary { background: #dfe1e6; color: #172b4d; }
        .info {
            font-size: 12px;
            color: #5e6c84;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üì• T√©l√©chargement des pi√®ces jointes</h1>
        <div id="status" class="status loading">
            <span class="spinner"></span>
            Initialisation...
        </div>
        <div id="actions"></div>
        <div id="info" class="info"></div>
    </div>

    <script>
        var API_KEY = '28d80811d05a80d515472323f02aab53';
        var APP_NAME = 'Attachments Downloader';
        var RETURN_URL = window.location.href.split('#')[0];
        var WORKER_URL = 'https://trello-proxy.joprowork.workers.dev/';
        
        var statusEl = document.getElementById('status');
        var actionsEl = document.getElementById('actions');
        var infoEl = document.getElementById('info');
        
        var urlParams = new URLSearchParams(window.location.search);
        var cardId = urlParams.get('cardId');
        var cardName = urlParams.get('cardName') || 'carte';
        
        // R√©cup√©rer le token
        var token = null;
        var hash = window.location.hash;
        if (hash && hash.indexOf('token=') !== -1) {
            token = hash.split('token=')[1].split('&')[0];
            localStorage.setItem('trello_token', token);
            window.history.replaceState({}, document.title, RETURN_URL);
        } else {
            token = localStorage.getItem('trello_token');
        }
        
        function setStatus(msg, type, showSpinner) {
            var spinner = showSpinner ? '<span class="spinner"></span>' : '';
            statusEl.innerHTML = spinner + msg;
            statusEl.className = 'status ' + type;
        }
        
        function authorize() {
            window.location.href = 'https://trello.com/1/authorize?' +
                'expiration=never&name=' + encodeURIComponent(APP_NAME) +
                '&scope=read&response_type=token&key=' + API_KEY +
                '&return_url=' + encodeURIComponent(RETURN_URL);
        }
        
        function sanitize(name) {
            return name.replace(/[<>:"/\\|?*]/g, '_').substring(0, 200);
        }
        
        async function downloadZip() {
            setStatus('Pr√©paration du t√©l√©chargement...', 'loading', true);
            infoEl.textContent = 'Le serveur t√©l√©charge et compresse vos fichiers. Cela peut prendre quelques instants...';
            
            try {
                // Appeler le Worker qui fait tout le travail
                var workerUrl = WORKER_URL + '?cardId=' + cardId + '&token=' + token + '&key=' + API_KEY;
                
                setStatus('T√©l√©chargement en cours...', 'loading', true);
                
                var response = await fetch(workerUrl);
                
                if (!response.ok) {
                    var errorText = await response.text();
                    throw new Error(errorText || 'Erreur serveur: ' + response.status);
                }
                
                // R√©cup√©rer le ZIP
                var blob = await response.blob();
                
                if (blob.size < 100) {
                    throw new Error('Fichier ZIP vide ou invalide');
                }
                
                // T√©l√©charger le fichier
                var zipName = sanitize(decodeURIComponent(cardName)) + '.zip';
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = zipName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setStatus('‚úÖ T√©l√©chargement termin√© !', 'success', false);
                infoEl.textContent = '';
                actionsEl.innerHTML = '<button class="btn secondary" onclick="window.close()">Fermer</button>';
                
            } catch (e) {
                console.error('Erreur:', e);
                setStatus('‚ùå ' + e.message, 'error', false);
                infoEl.textContent = '';
                
                if (e.message.indexOf('401') !== -1 || e.message.indexOf('Token') !== -1) {
                    actionsEl.innerHTML = '<button class="btn" onclick="localStorage.removeItem(\'trello_token\'); authorize();">Se reconnecter √† Trello</button>';
                } else {
                    actionsEl.innerHTML = '<button class="btn" onclick="location.reload();">R√©essayer</button><button class="btn secondary" onclick="window.close()">Fermer</button>';
                }
            }
        }
        
        async function main() {
            if (!cardId) {
                setStatus('‚ùå Erreur: ID de carte manquant', 'error', false);
                return;
            }
            
            if (!token) {
                setStatus('Connexion √† Trello requise...', 'loading', true);
                setTimeout(authorize, 1500);
                return;
            }
            
            // Lancer le t√©l√©chargement
            downloadZip();
        }
        
        main();
    </script>
</body>
</html>
